version: "3.9"

# =============================================================================
# Pesaflow ML — Docker Compose
# =============================================================================
# Joins the backend's pesaflow-network to share Postgres, Redis, and Kafka.
# The main ML service uses the backend's Postgres (pesaflow DB, ai_schema).
# Airflow and MLflow get their own dedicated Postgres databases.
# =============================================================================

services:
  # === Pesaflow ML Fraud & AML Service ===
  pesaflow-ml:
    build:
      context: .
      dockerfile: docker/Dockerfile
    container_name: pesaflow-ml
    ports:
      - "18743:8000"
    environment:
      - ENVIRONMENT=development
      - DEBUG=true
      - LOG_LEVEL=INFO
      # Main DB: backend's Postgres (shared pesaflow DB, ai_schema/fraud_schema)
      - DATABASE_URL=postgresql+asyncpg://pesaflow:pesaflow_secure_2024@pesaflow-postgres:5432/pesaflow
      - DATABASE_SYNC_URL=postgresql://pesaflow:pesaflow_secure_2024@pesaflow-postgres:5432/pesaflow
      - DATABASE_SCHEMA=ai_schema
      # Backend's Redis (no password, DB 2 to avoid collisions)
      - REDIS_URL=redis://pesaflow-redis:6379/2
      # Backend's Kafka
      - KAFKA_BOOTSTRAP_SERVERS=pesaflow-kafka:29092
      - MLFLOW_TRACKING_URI=http://pesaflow-ml-mlflow:5000
      - MODEL_STORAGE_PATH=/app/model_artifacts
      - JWT_SECRET=dev-secret-change-in-production
    depends_on:
      ml-postgres:
        condition: service_healthy
    networks:
      - pesaflow-network
      - ml-internal
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health/live"]
      interval: 30s
      timeout: 10s
      start_period: 60s
      retries: 3
    volumes:
      - model_artifacts:/app/model_artifacts
    restart: unless-stopped

  # === ML-Internal PostgreSQL (Airflow + MLflow only) ===
  ml-postgres:
    image: postgres:16-alpine
    container_name: pesaflow-ml-postgres
    ports:
      - "25431:5432"
    environment:
      POSTGRES_USER: pesaflow_ml
      POSTGRES_PASSWORD: ml_db_secure_2024
      POSTGRES_DB: pesaflow_mlflow
      POSTGRES_MULTIPLE_DATABASES: pesaflow_airflow
    volumes:
      - ml_postgres_data:/var/lib/postgresql/data
      - ./infrastructure/init-ml-postgres.sh:/docker-entrypoint-initdb.d/01-init-ml-postgres.sh
    networks:
      - ml-internal
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U pesaflow_ml -d pesaflow_mlflow"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # === Redis (ML-dedicated, for feature store & velocity counters) ===
  redis:
    image: redis:7-alpine
    container_name: pesaflow-ml-redis
    ports:
      - "26379:6379"
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    volumes:
      - redis_data:/data
    networks:
      - ml-internal
      - pesaflow-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # === Kafka (KRaft mode — ML-dedicated) ===
  kafka:
    image: bitnami/kafka:3.7
    container_name: pesaflow-ml-kafka
    ports:
      - "29094:9092"
    environment:
      KAFKA_CFG_NODE_ID: 0
      KAFKA_CFG_PROCESS_ROLES: controller,broker
      KAFKA_CFG_CONTROLLER_QUORUM_VOTERS: 0@pesaflow-ml-kafka:9093
      KAFKA_CFG_LISTENERS: PLAINTEXT://:29092,CONTROLLER://:9093,EXTERNAL://:9092
      KAFKA_CFG_ADVERTISED_LISTENERS: PLAINTEXT://pesaflow-ml-kafka:29092,EXTERNAL://localhost:29094
      KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP: CONTROLLER:PLAINTEXT,EXTERNAL:PLAINTEXT,PLAINTEXT:PLAINTEXT
      KAFKA_CFG_CONTROLLER_LISTENER_NAMES: CONTROLLER
      KAFKA_CFG_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_CFG_AUTO_CREATE_TOPICS_ENABLE: "true"
    volumes:
      - kafka_data:/bitnami/kafka
    networks:
      - ml-internal
    healthcheck:
      test: ["CMD-SHELL", "kafka-topics.sh --bootstrap-server localhost:29092 --list"]
      interval: 30s
      timeout: 10s
      start_period: 30s
      retries: 5
    restart: unless-stopped

  # === MLflow (own Postgres backend store) ===
  mlflow:
    image: ghcr.io/mlflow/mlflow:v2.16.0
    container_name: pesaflow-ml-mlflow
    ports:
      - "15937:5000"
    command: >
      mlflow server
        --host 0.0.0.0
        --port 5000
        --backend-store-uri postgresql://pesaflow_ml:ml_db_secure_2024@pesaflow-ml-postgres:5432/pesaflow_mlflow
        --default-artifact-root /mlflow/artifacts
    depends_on:
      ml-postgres:
        condition: service_healthy
    volumes:
      - mlflow_data:/mlflow
    networks:
      - ml-internal
    restart: unless-stopped

  # === Airflow (own Postgres backend, webserver + scheduler) ===
  airflow-init:
    image: apache/airflow:2.9.3-python3.11
    container_name: pesaflow-ml-airflow-init
    entrypoint: /bin/bash
    command: >
      -c "
        airflow db migrate &&
        airflow users create --username admin --password admin --firstname Pesaflow --lastname ML --role Admin --email admin@pesaflow.com || true
      "
    environment:
      AIRFLOW__CORE__EXECUTOR: LocalExecutor
      AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: postgresql+psycopg2://pesaflow_ml:ml_db_secure_2024@pesaflow-ml-postgres:5432/pesaflow_airflow
      AIRFLOW__CORE__FERNET_KEY: ""
      AIRFLOW__CORE__LOAD_EXAMPLES: "false"
    depends_on:
      ml-postgres:
        condition: service_healthy
    networks:
      - ml-internal

  airflow-webserver:
    image: apache/airflow:2.9.3-python3.11
    container_name: pesaflow-ml-airflow-webserver
    command: webserver
    ports:
      - "28080:8080"
    environment:
      AIRFLOW__CORE__EXECUTOR: LocalExecutor
      AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: postgresql+psycopg2://pesaflow_ml:ml_db_secure_2024@pesaflow-ml-postgres:5432/pesaflow_airflow
      AIRFLOW__CORE__FERNET_KEY: ""
      AIRFLOW__CORE__LOAD_EXAMPLES: "false"
      AIRFLOW__WEBSERVER__EXPOSE_CONFIG: "true"
    depends_on:
      airflow-init:
        condition: service_completed_successfully
    volumes:
      - ./airflow/dags:/opt/airflow/dags
      - airflow_logs:/opt/airflow/logs
    networks:
      - ml-internal
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      start_period: 60s
      retries: 5
    restart: unless-stopped

  airflow-scheduler:
    image: apache/airflow:2.9.3-python3.11
    container_name: pesaflow-ml-airflow-scheduler
    command: scheduler
    environment:
      AIRFLOW__CORE__EXECUTOR: LocalExecutor
      AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: postgresql+psycopg2://pesaflow_ml:ml_db_secure_2024@pesaflow-ml-postgres:5432/pesaflow_airflow
      AIRFLOW__CORE__FERNET_KEY: ""
      AIRFLOW__CORE__LOAD_EXAMPLES: "false"
    depends_on:
      airflow-init:
        condition: service_completed_successfully
    volumes:
      - ./airflow/dags:/opt/airflow/dags
      - airflow_logs:/opt/airflow/logs
    networks:
      - ml-internal
    restart: unless-stopped

volumes:
  ml_postgres_data:
  redis_data:
  kafka_data:
  model_artifacts:
  mlflow_data:
  airflow_logs:

networks:
  # Shared with pesa-flow-backend
  pesaflow-network:
    external: true
    name: pesa-flow-backend_pesaflow-network
  # Internal ML network
  ml-internal:
    driver: bridge
